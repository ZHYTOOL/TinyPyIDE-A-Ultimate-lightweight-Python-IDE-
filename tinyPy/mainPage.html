<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Textarea Overlay Code Aligned</title>
    <link rel="stylesheet" href="./atom-one-dark.css">
    <script src="./highlight-min.js"></script>
    <style>
        body {
            background:#282C34;
            margin:0;
        }
        .toolbar {
            width: 100%;
            height: 44px;
            background: #21252b;
            color: #eee;
            display: flex;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: fixed;
            top:0;
            left:0;
            z-index: 100;
        }
        .toolbar .menu {
            padding: 0 28px;
            cursor: pointer;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 16px;
            transition: background .15s;
        }
        .toolbar .menu:hover {
            background: #444950;
        }

        .code-container {
            position: absolute;
            top:44px;
            left:0;
            width:90%;
            height:calc(100vh - 54px);
            background: #282C34;
            border-radius: 7px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: row;
        }
        .code-container::-webkit-scrollbar {
            width: 10px;
            background: #222;
        }
        .code-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #444950 60%, #35393f 100%);
            border-radius: 8px;
        }
        .code-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #606672 60%, #444950 100%);
        }
        .code-container {
            scrollbar-width: thin;
            scrollbar-color: #444950 #222;
        }

        #linenumbers {
            padding-top: 16px;
            padding-bottom: 16px;
            padding-left: 10px;
            width: 48px;
            min-width: 32px;
            background: #23262e;
            color: #5c6370;
            font-family: "Fira Mono", "Consolas", "Menlo", monospace;
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            user-select: none;
            pointer-events: none;
            border-top-left-radius: 7px;
            border-bottom-left-radius: 7px;
            overflow: hidden;
            height: 100%;
        }
        .editor-stack {
            flex: 1;
            position: relative;
            height: 100%;
        }
        #code, #infoGet,#warn {
            font-family: "Fira Mono", "Consolas", "Menlo", monospace;
            font-size: 18px;
            line-height: 1.6;
            padding: 16px;
            box-sizing: border-box;
            width: 100%;
            min-height: 100%;
            background: transparent;
            overflow: hidden;
            height: 100%;
        }
        #code {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 0;
            pointer-events: none;
            white-space: pre-wrap;
            /*word-break: break-all;*/
            color: #eee;
            overflow-wrap: break-word;
        }
        #infoGet {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 5;
            background: transparent;
            border: none;
            outline: none;
            color: transparent;
            caret-color: #ccc;
            resize: none;
        }
        #warn{
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 1;
            background: transparent;
            pointer-events: none;
            border: none;
            outline: none;
            color: red;
            caret-color: transparent;
            resize: none;
            white-space: pre-wrap;      /* 保持换行 */
            overflow: hidden;
        }
        pre.code-container {
            padding:0;
            margin:0;
        }

        /* 弹窗遮罩和内容 */
        .popup-mask {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30,34,40,0.55);
        }
        .popup {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #242731;
            color: #eee;
            border-radius: 8px;
            min-width: 240px;
            min-height: 90px;
            box-shadow: 0 12px 48px rgba(0,0,50,0.11);
            padding: 22px 28px 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 16px;
        }
        .popup-title {
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .popup-option {
            margin: 5px 0;
            padding: 5px 14px;
            border-radius: 6px;
            cursor: pointer;
            background: none;
            color: #bcbcbc;
            border: none;
            outline: none;
            font-size: 15px;
        }
        .popup-option:hover {
            color: #fff;
            background: #444950;
        }
        .popup-close {
            margin-top: 14px;
            align-self: flex-end;
            padding: 3px 18px;
            border-radius: 5px;
            background: #363a47;
            color: #eee;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }
        .popup-close:hover { background: #656c83;}
    </style>
</head>
<body>
<div class="toolbar">
    <span class="menu" data-key="File">File</span>
    <span class="menu" data-key="Edit">Edit</span>
    <span class="menu" data-key="Run">Run</span>
    <span class="menu" data-key="Help">Help</span>
</div>

<div class="popup-mask" id="popupMask">
    <div class="popup" id="popupBox">
        <!-- js填充内容 -->
    </div>
</div>

<div class="code-container" id="code-container">
    <div id="linenumbers"></div>
    <div class="editor-stack">
        <code class="language-python" id="code">#Start Coding!
</code>
        <textarea id="infoGet" spellcheck="false">#Start Coding!
</textarea>
        <textarea id="warn" spellcheck="false"></textarea>
        <div id="choice"></div>
    </div>
</div>

<script>
    hljs.highlightAll();
    let codes=[],codesIndex=0;
    const code = document.getElementById("code");
    const warn = document.getElementById("warn");
    let warns=[];
    const infoGet = document.getElementById("infoGet");
    const codeContainer = document.getElementById('code-container');
    const linenumbers = document.getElementById('linenumbers');
    let isFileSave=false,fileName=""
    let choose=0,chooseIt=false;

    function fitTextarea() {
        // 自动增高，防止溢出
        infoGet.style.height = "auto";
        code.style.height = "auto";
        warn.style.height="auto";
        let h = Math.max(infoGet.scrollHeight, codeContainer.clientHeight);
        infoGet.style.height = h + "px";
        code.style.height = h + "px";
        warn.style.height =h + "px"
        linenumbers.style.height = h + "px";
    }
    // 初始化
    fitTextarea();

    // 同步输入和高亮
    function fitInfo(){
        delete code.dataset.highlighted;
        code.textContent = infoGet.value;
        warn.value=""
        warnNeedCodes=infoGet.value.split('\n')
        if(warns!=[]){
            for(let i in warnNeedCodes) {
                for(let j in warnNeedCodes[i]){
                    let nowLine=Number(i)+1,nowColumn=Number(j)+1;
                    if(nowLine>=warns[0]&&nowLine<=warns[2]&&nowColumn>=warns[1]&&nowColumn<=warns[3]){
                        warn.value+='﹏'
                    }
                    else{
                        warn.value+=' '
                    }
                }
                warn.value+='\n'
            }
        }
        let info = infoGet.value;
        let codeList = info.split('\n');
        let lineShow = "";
        for(let i = 0; i < codeList.length; i++){
            lineShow += (i + 1) + "<br>";
        }
        linenumbers.innerHTML = lineShow;
        hljs.highlightElement(code);
        fitTextarea();
    }
    infoGet.addEventListener("input", () => {
        fitInfo()
        codes.push(infoGet.value)
        isFileSave=false
    });

    // 滚动时，子元素scroll跟随外层
    codeContainer.addEventListener("scroll", function() {
        const scrollTop = codeContainer.scrollTop;
        code.scrollTop = scrollTop;
        infoGet.scrollTop = scrollTop;
        warn.scrollTop=scrollTop;
        linenumbers.scrollTop = scrollTop;
    });

    // 初始化行号
    (function(){
        let info = infoGet.value;
        let codeList = info.split('\n');
        let lineShow = "";
        for(let i = 0; i < codeList.length; i++){
            lineShow += (Number(i) + 1).toString() + "<br>";
        }
        linenumbers.innerHTML = lineShow;
        hljs.highlightElement(code);
        fitTextarea();
    })();

    // === 弹窗逻辑，最小改动 ===
    // 菜单的子功能项（可以自定义为你想要的功能名）
    const menuOptions = {
        File: ["View File",  "Save", "Save As..."],
        Edit: ["Undo / Ctrl+Z", "Redo / Ctrl+Shift+Z"],
        Run: ["Run Code", "Run With Debugger"],
        Help: ["Download Library", "About"]
    };

    const popupMask = document.getElementById('popupMask');
    const popupBox = document.getElementById('popupBox');

    // 点击菜单弹出子功能弹窗
    document.querySelectorAll('.menu').forEach(menu => {
        menu.addEventListener('click', function(e){
            e.stopPropagation();
            const key = this.getAttribute('data-key');
            // 填充内容
            let html = `<div class="popup-title">${key}</div>`;
            (menuOptions[key] || []).forEach(opt =>
                html += `<button class="popup-option" onclick="Do('${opt}')">${opt}</button>`
            );
            html += `<button class="popup-close">Close</button>`;
            popupBox.innerHTML = html;
            popupMask.style.display = "block";
        });
    });

    // 关闭弹窗（点击遮罩或关闭按钮）
    popupMask.addEventListener('click', function(e){
        popupMask.style.display = "none";
    });
    // 阻止点击弹窗本体关闭遮罩
    popupBox.addEventListener('click', function(e){
        e.stopPropagation();
    });
    // 关闭按钮
    popupBox.addEventListener('click', function(e){
        if(e.target.classList.contains('popup-close')) {
            popupMask.style.display = "none";
        }
    });
    function Do(task){
        // window.pywebview.api.send_data("hello").then(function (response){
        //     popupMask.style.display = "none";
        //     alert(response)
        // })
        if(task=="View File"){
            popupMask.style.display = "none";
            let html = `<div class="popup-title">View File</div>`;
            window.pywebview.api.view_file('View Files').then((response)=>{
                console.log(typeof response,response)
                for(let i of response[0]){
                    html += `<button class="popup-option" onclick="Do('OpenFile>${i}')">${i}</button>`
                }
                html += `<button class="popup-close">Close</button>`;
                popupBox.innerHTML = html;
                popupMask.style.display = "block";
            })
            isFileSave=false
        }
        if(task.includes('OpenFile')){
            file=task.split('>')[1];
            window.pywebview.api.read_file(file).then((response)=>{
                console.log(typeof response,response)
                popupMask.style.display = "none";
                infoGet.value=response;
                fitInfo()
            })
        }
        if(task=="Run Code"){
            //console.log(isFileSave)
            if(isFileSave) {
                window.pywebview.api.run_code(fileName)
            }
            else{
                Do("Save")
                window.pywebview.api.run_code(fileName)
            }
        }
        if(task=="Run With Debugger"){
            //console.log(isFileSave)
            if(isFileSave) {
                window.pywebview.api.run_code_as_db(fileName)
            }
            else{
                Do("Save")
                window.pywebview.api.run_code_as_db(fileName)
            }
        }
        if(task=="Save"){
            let html = `<div class="popup-title">File Name</div>`;
            html += `<input class="popup-option" style="background-color:#ccc" id="fileNameBasic"></input>`
            html += `<button class="popup-close" onclick="SaveFileBasic()">OK</button>`;
            popupBox.innerHTML = html;
            popupMask.style.display = "block";
        }
        if(task=="Save As"){
            let html = `<div class="popup-title">File Name with full path</div>`;
            html += `<input class="popup-option" style="background-color:#ccc" id="fileName"></input>`
            html += `<button class="popup-close" onclick="SaveFile()">OK</button>`;
            popupBox.innerHTML = html;
            popupMask.style.display = "block";
        }
        if(task=="Download Library"){
            let html = `<div class="popup-title">Library Name</div>`;
            html += `<input class="popup-option" style="background-color:#ccc" id="libName"></input>`
            html += `<button class="popup-close" onclick="downloadLib()">OK</button>`;
            popupBox.innerHTML = html;
            popupMask.style.display = "block";
        }
        if(task=="About"){
            let html = `<div class="popup-title">About</div>`;
            html += `<button class="popup-option">Born for improvisation</button>`
            html += `<button class="popup-close">OK</button>`;
            popupBox.innerHTML = html;
            popupMask.style.display = "block";
        }
    }
    function SaveFileBasic(){
        fileName=document.getElementById("fileNameBasic").value
        window.pywebview.api.save_file_basic(fileName,infoGet.value).then((response)=>{
            console.log(response)
        })
        isFileSave=true
    }
    function SaveFile(){
        fileName=document.getElementById("fileName").value
        window.pywebview.api.save_file(fileName,infoGet.value)
        isFileSave=true
    }
    function downloadLib(){
        let libName=document.getElementById("libName").value
        window.pywebview.api.download_lib(libName)
    }
    /**
     * 获取 textarea 当前光标前后的字符
     * @param {HTMLTextAreaElement} textarea - 目标 textarea 元素
     * @returns {{before: string, after: string}} - 光标前后单个字符
     */
    function getCursorSurroundingChars(textarea) {
        const { selectionStart, selectionEnd, value } = textarea;
        // 通常插入点，selectionStart === selectionEnd
        let before = '', after = '';
        if (selectionStart > 0) {
            before = value[selectionStart - 1];
        }
        if (selectionEnd < value.length) {
            after = value[selectionEnd];
        }
        return { before, after };
    }
    /**
     * 获取光标实际像素坐标（相对于页面）
     * @param {HTMLTextAreaElement} textarea
     * @returns {left:number, top:number}
     */
    function getCaretPosition(textarea) {
        const div = document.createElement('div');
        const style = getComputedStyle(textarea);

        // 复制所有重要样式
        for (let prop of [
            'fontFamily', 'fontSize', 'fontWeight', 'fontStyle', 'letterSpacing', 'textTransform',
            'textAlign', 'direction', 'wordSpacing', 'lineHeight', 'paddingTop', 'paddingRight',
            'paddingBottom', 'paddingLeft', 'borderTopWidth', 'borderRightWidth',
            'borderBottomWidth', 'borderLeftWidth', 'boxSizing', 'width', 'height', 'overflow'
        ]) {
            div.style[prop] = style[prop];
        }

        // 复制内容与换行
        div.style.position = 'absolute';
        div.style.visibility = 'hidden';
        div.style.whiteSpace = 'pre-wrap';
        div.style.wordWrap = 'break-word';
        div.style.left = textarea.offsetLeft + 'px';
        div.style.top = textarea.offsetTop + 'px';
        div.style.zIndex = '-1';

        let text = textarea.value.substring(0, textarea.selectionStart);
        text = text.replace(/\n$/, '\n '); // chrome兼容补丁
        div.textContent = text;

        // 插入 span 标识光标位置
        const span = document.createElement('span');
        span.textContent = '|'; // 占位，不现实，测算宽度
        div.appendChild(span);

        document.body.appendChild(div);
        const rect = span.getBoundingClientRect();
        const containerRect = textarea.getBoundingClientRect();
        const left = rect.left, top = rect.top;

        document.body.removeChild(div);
        return {
            left: left,
            top: top
        };
    }
    function complete(){
        let {left,top}=getCaretPosition(infoGet)
        //console.log(left,top)
        if(window.pywebview) {
            setTimeout(() => {
                const { before, after } = getCursorSurroundingChars(infoGet);
                //console.log(after)
                if(after!='\n'&&before!=''&&before!='\n'){
                    window.pywebview.api.complete(infoGet.value).then((response) => {
                        let html=`<div style="position:absolute;top:${top}px;left:${left}px;text-align:left;flex:wrap;">`
                        for(let i in response){
                            if(chooseIt==true){
                                infoGet.value+=response[i][1];
                                chooseIt=false
                                fitInfo()
                            }
                            if(i==choose) {
                                html += `<button class="popup-option" style="color:brown" onclick="Do('Complete>${response[i][1]}')">${response[i][0]} => ${response[i][0]}</button><br>`
                            }
                            else{
                                html += `<button class="popup-option" onclick="Do('Complete>${response[i][1]}')">${response[i][1]} => ${response[i][0]}</button><br>`
                            }
                        }
                        html+="</div>"
                        document.getElementById('choice').innerHTML=html;
                    })
                }
            },0)
        }
    }
    function showErrors(){
        if(window.pywebview) {
            window.pywebview.api.get_errors(infoGet.value).then((response)=>{
                if(response!==null){
                    warns=response;
                }
            })
        }
    }
    setInterval(()=>{
        complete();
        showErrors();
    },100)
    infoGet.addEventListener("keydown",(event)=>{
        if(event.key=="ArrowDown"){
            choose+=1;
        }
        if(event.key=="ArrowUp"){
            if(choose>0){
                choose-=1;
            }
        }
        if(event.key=="Tab"){
            choose=0;
            chooseIt=true;
        }
    })
    infoGet.addEventListener('keydown', function (event) {
        if (event.ctrlKey && event.key.toLowerCase() === 'z') {
            if(codes[codes.length+codesIndex]-2!=undefined) {
                codesIndex -= 1;
                infoGet.value = codes[codes.length - 1 + codesIndex]
                fitInfo()
            }
        }
    });
    document.addEventListener('keydown', function (event) {
        if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'z') {
            if(codes[codes.length+codesIndex]!=undefined) {
                codeIndex += 1;
                infoGet.value = codes[codes.length - 1 + codesIndex]
                fitInfo()
            }
        }
    });
</script>
</body>
</html>